var Promise = require('es6-promise').Promise;

function request(url, opts) {
  // Return a new promise.
  return new Promise(function(resolve, reject) {

    opts = defaults(opts, {
      method: "GET",
      headers: {}
    });

    // Do the usual XHR stuff
    var req = new XMLHttpRequest();
    req.open(opts.method, url);

    for (var header in opts.headers) {
      req.setRequestHeader(header, opts.headers[header]);
    }

    req.onload = function() {
      // This is called even on 404 etc
      // so check the status
      if (req.status == 200) {
        // Resolve the promise with the response text
        resolve(req.response);
      }
      else {
        // Otherwise reject with the status text
        // which will hopefully be a meaningful error
        reject(Error(req.statusText));
      }
    };

    // Handle network errors
    req.onerror = function() {
      reject(Error("Network Error"));
    };

    // Make the request
    req.send();
  });
}

function defaults(opts, defaultOpts) {
  var r = Object.create(defaultOpts);

  if (!opts) { return r; }
  
  for (var key in opts) if (opts.hasOwnProperty(key)) {
    r[key] = opts[key];
  }

  return r;
}

function toQuerystring(obj) {
  var str = [];
  for (var p in obj)
    if (obj.hasOwnProperty(p)) {
      str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
    }
  return str.join("&");
}

var strToEls = (function () {
  var tmpEl = document.createElement('div');
  return function (str) {
    var r = document.createDocumentFragment();
    tmpEl.innerHTML = str;
    while (tmpEl.childNodes[0]) {
      r.appendChild(tmpEl.childNodes[0]);
    }
    return r;
  };
}());


module.exports = {
  request: request,
  defaults: defaults,
  toQuerystring: toQuerystring,
  strToEls: strToEls
};